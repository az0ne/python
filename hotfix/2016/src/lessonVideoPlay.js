/*! LPS4.0 2016-10-20
*/
var tempImg=[],attachImg=[],init=function(){function e(){return parseInt($(".lesson li .selected").text())}function t(e){$.cookie("pop_career_no_longer_remind_flag",e,{expires:365,path:"/course/"})}function i(){return $.cookie("pop_career_no_longer_remind_flag")}function n(){return window.ActiveXObject||"ActiveXObject"in window?!0:!1}function s(){var e=Math.ceil(w.currentTime);if($.cookie("lesson_"+$lessonId,e),e&&"True"==$thisUser){var t=$videoLength;1==S&&$classId.length>0&&e/t>$videoExamComplete&&(S=!1,$.get("/lps3/student/ajax/item_lesson/update/"+$userItem))}}function o(){var e=$(".video_part_lists li.liH").next();return Boolean(e.length)}function a(){var e=$(".video_part_lists li.liH").next();window.location=e.children().get(0).href}function l(e,t){$(e).jScrollPane({mouseWheelSpeed:t})}function r(e,t,i){var n="";return n+="<li>",n+='<i id="'+i+'" class="remove-img"></i>',n+='<img _src="'+e+'" src="'+t+'" height="120" width="120"/>',n+="</li>"}function c(e){for(var t="",i=0;e.length>i;i++)t+=r(e[i][1],e[i][0],i);E.html(""),E.append(t),E.append(M),E.find("li").length>4&&E.find("li.last").hide().prev().css("margin-right",0),$(".remove-img").on("click",function(){$(this).parent().remove();var e=$(this).attr("id");4>=E.find("li").length&&E.find("li.last").show().prev().css("margin-right","20px"),tempImg.splice(e,1)}),$("#uploadPreview").fileupload({url:"/common/img/upload/",dataType:"json",autoUpload:!0,add:function(e,t){var i=[],n=/^(png|jpg|jpeg)$/i,s=t.originalFiles[0].size/1024;Ntype=t.originalFiles[0].name.split("."),Ntype=Ntype[Ntype.length-1],n.test(Ntype)||(O.text("图片格式不正确！").css({color:"#F01400"}),i.push("Not an accepted file type"),setTimeout(function(){O.html(U).css({color:"#666"})},2e3)),parseInt(s)>500&&(O.text("文件超过500KB大小！").css({color:"#F01400"}),i.push("Filesize is too big"),setTimeout(function(){O.html(U).css({color:"#666"})},2e3)),0==i.length&&t.submit()},done:function(e,t){void 0!=t.result.data.result.img_url&&void 0!=t.result.data.small_result.img_url&&tempImg.push([t.result.data.small_result.img_url,t.result.data.result.img_url]),c(tempImg)}})}function u(e){return(e+"").replace(/[^\x00-\xff]/g,"aa").length}function d(e){var t=$("#target").offset(),i=$('<div id="boll" class="boll"></div>');i.fly({start:{left:e.pageX,top:e.pageY},end:{left:t.left+10,top:t.top+10},onEnd:function(){this.destory()}})}function p(){if("True"!=$thisUser)return!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"),!1;var e=$(".reply-total");e.unbind(),e.on({click:function(){L.css("margin-left","-360px"),nt.css("bottom",0),st=$(this).parents("li").find(".last_id").val(),ot=st,at=$(this).parents("li").find(".answer_user_id").val(),lt=$(this).parents("li").find(".answer_nick_name").val(),rt="回复"+$.trim(lt)+":",nt.find("textarea").attr({placeholder:rt})}})}function m(){tt.on("click",function(){var e=$("textarea").val();$(this).off(),ct(X,st,ot,e,at,lt)})}function h(){if("True"!=$thisUser)return!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"),!1;var e=$(this).text();e=e.split(":");for(var t=0,i=0;e.length>i;i++)t+=parseInt(e[i])*Math.pow(60,e.length-1-i);w.currentTime=t}function g(){var e=$(".zyleve1>li,.zvrightSreen .d-task-list li.last");e.each(function(t,i){if($(i).hasClass("liH")){var n=e.eq(t+1);if(n.find("a").attr("href")){var s=n.find("a").attr("hid_href");s&&(location.href=s)}else n.find("a").trigger("click")}})}var v,f,_=$("video"),w=_[0];$(".ldFeedback a").mouseover(function(){$(this).siblings(".feedboxTip").stop().slideDown(150).animate({opacity:"1"},400)}),$(".feedboxTip .closed").click(function(){$(this).parent().stop().animate({opacity:"0"},250).slideUp(500)}),"False"==$thisUser&&!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录");var b=$(".check_box"),y=$(".lesson li"),x=$("#check_lesson_lists"),k=$("#just_pay"),C=0,T=$needPay,F=$isPaid,q=i()||!1,S=!0;y.each(function(){return C++,$(this).children().hasClass("need_pay")?!1:void 0}),x.on("click",".close",function(){x.modal("hide")}),k.on("click",".close",function(){k.modal("hide")}),b.on("click",function(){$(this).hasClass("in")?(t(!1),$(this).removeClass("in")):(t(!0),$(this).addClass("in"))}),setInterval(function(){w.paused||$.get("/v4/append_study_info?course_id="+$courseId+"&lesson_id="+$lessonId)},6e4),$(".vjs-error-display").html('<div><img src="/images/refresh.png">&nbsp;&nbsp;视频加载失败，请<a onclick="location.reload();" style="cursor: pointer;">刷新重试</a></div>'),$("#microohvideo").append($(".videoStopMeg"));var I=$.cookie("lesson_"+$lessonId)?$.cookie("lesson_"+$lessonId):0;_.ready(function(){n()||(w.currentTime=I),setInterval(function(){s()},1e3),_.on("play",function(){if(F=!0,"False"==$thisUser)startPause(),!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录");else{if(3==e()&&$needPay&&!$isPaid&&$ifHaveCareerCourse)return w.currentTime>60&&T&&F&&(F=!1,startPause(),pop_pay()),setInterval(function(){w.currentTime>60&&T&&F&&(F=!1,startPause(),pop_pay())},1e3),!1;if(e()>3&&$needPay&&!$isPaid&&$ifHaveCareerCourse)return T&&F&&(F=!1,startPause(),pop_pay()),!1}}),_.on("ended",function(){q||$ad||$isPaid||!x.hasClass("in")&&0>=$(".modal-backdrop").length&&x.modal("show"),$.cookie("lesson_"+$lessonId,null)})}),$(".VSMbtn1").on("click",function(){"True"==$thisUser?(w.pause(),w.paused&&(startPause(),S=!0)):!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录")}),$(".VSMbtn").on("click",".VSMbtn2",function(){if(o())a();else{w&&w.cancelFullScreen();var e=$(".zvright a").eq(0);e.hasClass("aH")||e.trigger("click")}}),"False"==$thisUser&&$(".zvrightSreen3 a").each(function(){$(this).on("click",function(){!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录")})}),v=$(".video_part_lists li.liH a").find(".col_l").text(),f=$(".zyleve1 li.liH a").attr("title"),$(".zyNewVideo_top .s").html(v||f),$(".zvideo_index").width();var M="<li class='last'><span class='font14 color66 uploadPreview'><i class='add-screenshot-img'></i><input type='file' name='image' accept='image/*' multiple id='uploadPreview'><span class='add-img-msg font14 color66'>添加图片</span></span></li>",j=($(".bottom-module"),$(".tiwen-con")),P=($(".user"),$(".share"),$(".down-load"),$(".message-wrap"),$(".alt-ta"),$(".btn-box"),$(".tiwen-btn")),z=($(".cancel-btn"),$(".current"),$(".current-time"),$(".upload-con")),A=$(".upload-img"),B=$("#insert-img"),E=$("#insert-img-list"),W=$(".cancel-insert-btn"),H=$(".insert-img-btn"),z=$(".upload-con"),O=$(".msg"),U=([j,B,$(".questions-top a"),$(".questions-bottom .share"),$(".question-current span")],O.html());P.on("click",function(e){if("False"==$thisUser)!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录");else{for(var t=$("#insert-img-list img"),i=[],n=[],s=0;t.length>s;s++){var o=t.eq(s).attr("_src"),a=t.eq(s).attr("src");o&&a&&(o=o.split("/uploads/")[1],a=a.split("/uploads/")[1],i.push(o),n.push(a))}var l={discuss_location:G,object_id:X,object_name:J,comment:textMsg.val(),object_content:$(".message-wrap .current-time").text(),material_arr:i,small_material_arr:n},r=Math.ceil(u($(".text-msg").val()));""==textMsg.val()?layer.tips("请输入您的问题。",textMsg,{tips:[1,"#5ECFBA"],time:4e3}):r>1e3?layer.tips("输入超过1000字，请重新输入。",textMsg,{tips:[1,"#5ECFBA"],time:4e3}):"teacher"==$groupName?layer.tips("对不起，老师不能提问。",textMsg,{tips:[1,"#5ECFBA"],time:4e3}):(d(e),$.ajax({url:"/common/question_post/",data:l,dataType:"json",type:"POST",success:function(e){var t=$(".all-questions, .my-questions");"success"==e.status&&(t.each(function(e,t){0==$(t).find("ul").length&&($(t).find(".no-answer").remove(),$(t).children().children().html('<ul></ul><a class="load-more">加载更多</a>'))}),t.find("ul").prepend(e.html),E.html(""),E.append(M),ut(),p()),textMsgTxt=""}}),initTextMsg(),attachImg=[],tempImg=[],z.children(".pin").remove())}}),A.on("click",function(){"False"==$thisUser?!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"):($(this).parent(".message_wrap").addClass("actived"),O.html(U).css({color:"#666"}),E.html(""),tempImg=attachImg,c(tempImg),B.modal("show"))}),H.on("click",function(){B.modal("hide"),attachImg=tempImg,tempImg=[],attachImg.length>0?$(".upload_btn").addClass("have_img"):$(".upload_btn").removeClass("have_img"),$(".message_wrap").removeClass("actived")}),W.on("click",function(){O.html(U).css({color:"#666"}),B.modal("hide"),tempImg=[],0==attachImg.length&&(z.children(".pin").remove(),$(".upload_btn").removeClass("have_img")),$(".message_wrap").removeClass("actived")});var Q=$(".tab-nav li"),N=$(".tab-box > div"),V=$(".all-questions"),D=$(".my-questions"),L=($(".all-questions-lists"),$(".questions-box")),R=$("#back-questions"),X=($(".reply-total"),$(".object_id").val()),J=($(".class_id").val(),$(".object_name").val()),G=$(".discuss_location").val(),Y=!1;Q.on("click",function(){if("True"!=$thisUser)return!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"),!1;var e=$(this).index();$(this).addClass("active").siblings().removeClass("active"),N.eq(e).show().siblings().hide(),l(".all-questions, .my-questions",100)});var K=function(e){return"True"!=$thisUser?(!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"),!1):(l(".one-question-view",100),L.css("margin-left","-360px"),V.css("opacity",0),D.css("opacity",0),e=isNaN(e)?$(this).find(".last_id").val():e,pt(e),void 0)};$(function(){if(window.location.search.length>0){var e=window.location.search.split("="),t=e[e.length-1];$(".zvright a").eq(1).trigger("click"),Y=!0,K(t)}}),$(".all-questions, .my-questions").on({click:K},"li"),R.on("click",function(){L.css("margin-left","0"),V.css("opacity",1),D.css("opacity",1)});var Z=null;$(".one-question-view").on({click:function(e){e.stopPropagation(),Z=$(this).attr("_src"),imgPopup(Z)}},".questions-img img");var et,tt,it,nt,st,ot,at,lt,rt;et=$(".reply-btn"),tt=$(".submit-reply-btn"),it=$(".reply-msg"),nt=$(".reply-textarea"),st=null,ot=null,at=null,lt=null,rt=null,nt.find("textarea").keyup(function(e){e.stopPropagation()}),$(document).on("click",".reply-btn",function(){$(".reply-textarea").css("bottom",0),$(this).parent().hasClass("reply-date")?(st=$(this).parents(".right").siblings(".left").find(".last_id").val(),ot=$(this).parents(".right").siblings(".left").find(".problem_id").val(),at=$(this).parent().parent().parent().siblings(".left").find(".answer_user_id").val(),lt=$(this).parent().parent().parent().siblings(".left").find(".answer_nick_name").val(),rt="回复"+$.trim(lt)+":"):(st=$(this).parent().siblings(".last_id").val(),ot=st,at=$(this).parent().siblings(".answer_user_id").val(),lt=$(this).parent().siblings(".answer_nick_name").val(),rt="回复"+$.trim(lt)+":"),nt.find("textarea").attr({placeholder:rt})}),p(),m();var ct=function(e,t,i,n,s,o){var a="";""==n?(a=$("<span>请输入回复内容！</span>"),$(".submit-reply-btn").before(a),setTimeout(function(){a.remove()},2e3)):$.ajax({url:"/common/answer_post/",data:{object_id:e,parent_id:t,problem_id:i,comment:n,answer_user_id:s,answer_nick_name:o},dataType:"json",type:"POST",success:function(e){"success"==e.status?(e.parent_id==e.problem_id?$(".question-lists").prepend(e.html):$("#answer_"+e.parent_id).after(e.html),$(".reply-textarea").css("bottom","-180px").find("textarea").val(""),$(".one-question-view .load-more").text("没有更多"),$(".one-question-view").jScrollPane({mouseWheelSpeed:100})):(a=$("<span>"+e.msg+"</span>"),$(".submit-reply-btn").before(a),setTimeout(function(){a.remove()},2e3)),m()}})},ut=function(){var e=$(".good");e.unbind(),e.on({click:function(e){if("True"!=$thisUser)return!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"),!1;e.stopPropagation();var t=$(this),i=t.parent().siblings(".last_id").val();t.children("small"),$.ajax({url:"/home/s/ajax_praise/",method:"POST",dataType:"json",data:{problem_id:i},success:function(e){if(e.success){var t=e.data.action,n=e.data.praise_count;$(".last_id").each(function(){var e=$(this),s=e.parent().find(".good");if(e.val()==i){var o=$(s).children("small");"mark"==t?(o.html(n),s.addClass("jia-good")):"cancel"==t&&(o.html(n),s.removeClass("jia-good"))}})}else if(401==e.code)return!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("登录状态已过期！"),!1}})}})};ut(),$(".reply-cancel").on("click",function(){$(".reply-textarea").css("bottom","-180px")}),$(".load-more").on("click",function(){var e=null,t=null,i=null;$(this).parents(".scroll-pane").hasClass("one-question-view")?(e=$(this).siblings().find(".questions-reply").last().find(".last_id").val(),i=$(this).siblings().find(".questions-reply").last().find(".problem_id").val(),t=$(this).siblings().find(".question-lists")):(e=$(this).siblings().children().last().find(".last_id").val(),i=$(this).siblings().children().last().find(".object_id").val(),t=$(this).siblings());var n=$(this).parents(".scroll-pane").attr("class").split(" ")[0],s=n.split("-")[0];dt(i,e,n,s,t)});var dt=function(e,t,i,n,s){return"True"!=$thisUser?(!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup("请先登录"),!1):($.ajax({url:"/common/"+n+"_more/"+e+"/"+t+"/",dataType:"html",type:"GET",success:function(e){"failed"==$.parseJSON(e).status?$("."+i+" .load-more").text("没有更多").off("click"):s.append($.parseJSON(e).html),$(".all-questions, .my-questions, .one-question-view").jScrollPane({mouseWheelSpeed:100}),ut()}}),void 0)},pt=function(e){$.ajax({url:"/common/one_more/"+e+"/0/",dataType:"html",type:"GET",success:function(t){$(".one-question-view li").empty().append($.parseJSON(t).html),0==$.parseJSON(t).has_answer?$(".one-question-view .load-more").text("暂无回答"):$(".one-question-view .load-more").text("加载更多"),$(".one-question-view").jScrollPane({mouseWheelSpeed:100}),ut(),1==Y&&($(".question-current span").trigger("click"),Y=!1),$.getScript("http://v3.jiathis.com/code/jia.js?uid=1680508"),jiathis_config={data_track_clickback:!0,shortUrl:!1,hideMore:!1,url:window.location.origin+"/u/"+$(".answer_user_id").val()+"/discuss/?p_id="+e,summary:"我正在麦子学院学习"+$(document).attr("title")+",赶快和我一起来感受神奇的在线学习方式吧！——麦子学院，在线学习好工作。",title:$(".one-question-view .question-title").text()}}})};$(".content_left").on({click:h},".question-current span"),$(".question-current span").on({click:h}),$(".play-next-control,.VSMbtn2").on("click",function(){if($classId.length>0)g();else{var e=null;$(".lesson li").each(function(){return $(this).children().hasClass("selected")?(e=$(this).next().children().attr("href"),!0):void 0}),e?window.location.href=e:layer.alert("没有下一节！",{skin:"layui-layer-molv",closeBtn:0})}});var mt={};$(".show-remark").on({click:function(){$.ajax({type:"GET",url:$("#questionnaire_url").val(),dataType:"json",success:function(e){1==e.success?window.location.href=$("#next_url").val():($("#satisfy-examen").html(e.data.html).modal({show:!0,keyboard:!1,backdrop:"static"}),$(".satisfy-list li").each(function(){$(this).find("label").click(function(){$(this).parent().addClass("now").siblings().removeClass("now"),$(this).addClass("select").parent().siblings().children().removeClass("select");var e=$(this).parent().parent().siblings().attr("id"),t=$(this).attr("value"),i=$(this).text();mt[e]='{"'+t+'":"'+i+'"}'})}),$(".button-group").on({click:function(){$.ajax({type:"POST",url:$("#submit_url").val(),data:mt,dataType:"json",success:function(e){"success"==e.msg?window.location.href=$("#next_url").val():"fail"==e.msg?$(".modal-content .err_msg").text(e.data).show().fadeOut(8e3,$("#satisfy-examen").modal("hide")):$(".modal-content .err_msg").text(e.data).show().fadeOut(3e3)}})}},".submit"))}})}}),$("#satisfy-examen").on({click:function(){window.location.href=$("#next_url").val()}},".next-time")};!function(e){e.fly=function(t,i){var n={version:"1.0.0",autoPlay:!0,vertex_Rtop:20,speed:1.2,start:{},end:{},onEnd:e.noop},s=this,o=e(t);s.init=function(e){this.setOptions(e),!!this.settings.autoPlay&&this.play()},s.setOptions=function(t){this.settings=e.extend(!0,{},n,t);var i=this.settings,s=i.start,a=i.end;o.css({marginTop:"0px",marginLeft:"0px",position:"fixed"}).appendTo("body"),null!=a.width&&null!=a.height&&e.extend(!0,s,{width:o.width(),height:o.height()});var l=Math.min(s.top,a.top)-Math.abs(s.left-a.left)/3;i.vertex_Rtop>l&&(l=Math.min(i.vertex_Rtop,Math.min(s.top,a.top)));var r=Math.sqrt(Math.pow(s.top-a.top,2)+Math.pow(s.left-a.left,2)),c=Math.ceil(Math.min(Math.max(Math.log(r)/.05-75,30),100)/i.speed),u=s.top==l?0:-Math.sqrt((a.top-l)/(s.top-l)),d=(u*s.left-a.left)/(u-1),p=a.left==d?0:(a.top-l)/Math.pow(a.left-d,2);e.extend(!0,i,{count:-1,steps:c,vertex_left:d,vertex_top:l,curvature:p})},s.play=function(){this.move()},s.move=function(){var t=this.settings,i=t.start,n=t.count,s=t.steps,a=t.end,l=i.left+(a.left-i.left)*n/s,r=0==t.curvature?i.top+(a.top-i.top)*n/s:t.curvature*Math.pow(l-t.vertex_left,2)+t.vertex_top;if(null!=a.width&&null!=a.height){var c=s/2,u=a.width-(a.width-i.width)*Math.cos(c>n?0:(n-c)/(s-c)*Math.PI/2),d=a.height-(a.height-i.height)*Math.cos(c>n?0:(n-c)/(s-c)*Math.PI/2);o.css({width:u+"px",height:d+"px","font-size":Math.min(u,d)+"px"})}o.css({left:l+"px",top:r+"px"}),t.count++;var p=window.requestAnimationFrame(e.proxy(this.move,this));n==s&&(window.cancelAnimationFrame(p),t.onEnd.apply(this))},s.destory=function(){o.remove()},s.init(i)},e.fn.fly=function(t){return this.each(function(){void 0==e(this).data("fly")&&e(this).data("fly",new e.fly(this,t))})}}(jQuery),init();