/*! LPS4.0 2016-11-01
*/
$(function(){function t(t){t=t?t:"请先登录",!$("#loginModal").hasClass("in")&&0>=$(".modal-backdrop").length&&login_popup(t)}function e(t){return(t+"").replace(/[^\x00-\xff]/g,"aa").length}function i(){return window.innerHeight/4}function s(){$(".more_discuss").off("click").on("click",function(){var t=$(this).text(),e=$(this);t.split("收起↑").length>1?($(this).siblings("dd:gt(1)").slideUp(500),setTimeout(function(){n(e)},500),$(this).text($(this).attr("value"))):($(this).siblings("dd:eq(1)").find(".children_text").removeClass("no_bd_btm"),$(this).siblings("dd:gt(1)").slideDown(500),$(this).text("收起↑"))})}function n(t){$(t).siblings("dd:eq(1)").find(".children_text").addClass("no_bd_btm")}function a(){r(),d(),k(),p(),showBigImgMain(),s()}function l(){$("#insert-img-list li:not(.last)").remove(),attachImg=[],tempImg=[]}function r(){$(".reply").off("click").on("click",function(){if(g){var e=$(this).parent(".children_lower,.parent_lower").siblings(".children_reply,.parent_reply").css("display");"none"==e?$(this).parent(".children_lower,.parent_lower").siblings(".children_reply,.parent_reply").slideDown(300):$(this).parent(".children_lower,.parent_lower").siblings(".children_reply,.parent_reply").slideUp(300),$(this).toggleClass("selected")}else t()})}function o(t){$(t).attr("disabled","disabled")}function c(t){$(t).removeAttr("disabled")}function p(){var t=$(".button .submit");t.off("click").on("click",function(){o(this);var t=null,e=null,i=null,s=null,n=$.trim($(this).parent().siblings(".input_area").children("textarea").val());$(this).parent().parent().hasClass("parent_reply")?(t=$(this).parents("li").children(".last_id").val(),e=t,i=0,s=""):(t=$(this).parents("li").children(".last_id").val(),e=t,i=$(this).parents("._reply").siblings(".answer_user_id").val(),s=$(this).parents("._reply").siblings(".answer_nick_name").val()),A(y,t,e,n,i,s,this)})}function h(){C.text("加载更多↓"),C.off("click").on("click",function(){var t=$(".QA_lists"),e=t.children("li").last(),i=$(e).find(".last_id").val(),s=y,n=$(".my_join em").hasClass("actived")?"my":"all";q(s,i,n,t)})}function d(){$(".cancel").off("click").on("click",function(){$(this).parent(".button").parent(".children_reply,.parent_reply").slideUp(300),$(this).parent(".button").parent(".children_reply,.parent_reply").siblings(".children_lower,.parent_lower").children(".reply").removeClass("selected")})}function m(t){$(".QA_lists, .QA_more").hide(),$(".newest_QA .empty_qa").length>0?_(t):"all"==t?$(".newest_QA").append('<div class="empty empty_qa"><img src="/images/video_play/empty_QA.png"></div>'):$(".newest_QA").append('<div class="empty empty_qa"><img src="/images/video_play/empty_QA_me.png"></div>')}function u(){$(".QA_lists").show(),$(".QA_more").show(),$(".newest_QA .empty_qa").remove()}function _(t){"all"==t?$(".newest_QA .empty_qa img").attr("src","/images/video_play/empty_QA.png"):$(".newest_QA .empty_qa img").attr("src","/images/video_play/empty_QA_me.png")}function f(t){var e=$(".lesson"),i=$(".video").height()-Q.height()-T.height(),s=parseInt(e.children("ul").css("margin-top").split("px")[0]),n=e.children("ul").children("li").eq(-1).position().top;T.removeAttr("title"),i>n?Q.attr("title","这已是最后一页"):(Q.removeAttr("title"),s-=i,s=s*t+"px",e.children("ul").animate({"margin-top":s},500))}var g="True"==$thisUser,v=$(".quiz_input");$(".QA_lists");var b=$(".tea_intro>p").height();b>72&&$(".tea_intro").siblings(".show_more").css({display:"inline-block"}),$(".quiz_time").off().on("click",function(){}),$(".content_left .tab ul li").click(function(){$(this).addClass("selected").siblings().removeClass("selected");var t=$(this).index();$(".tab_content > div").eq(t).show().siblings().hide(),t>0?$(".my_join").hide():$(".my_join").show()}),s();var y=$("#lesson_id").val(),w=$("#lesson_name").val(),x=$("#discuss_location").val();$(".submit_div .submit").on("click",function(){if(!g)return t(),!1;o(this);for(var s=$("#insert-img-list img"),n=[],r=[],p=this,h=0;s.length>h;h++){var d=s.eq(h).attr("_src"),m=s.eq(h).attr("src");d&&m&&(d=d.split("/uploads/")[1],m=m.split("/uploads/")[1],n.push(d),r.push(m))}var _={discuss_location:x,object_id:y,object_name:w,comment:$.trim(v.val()),object_content:$(".progressTime .current").text(),material_arr:n,small_material_arr:r},f=Math.ceil(e(v.val()));""==$.trim(v.val())?(layer.tips("请输入您的问题。",v,{tips:[1,"#5ECFBA"],time:4e3}),c(this)):f>1e3?(layer.tips("输入超过1000字，请重新输入。",v,{tips:[1,"#5ECFBA"],time:4e3}),c(this)):"teacher"==$groupName?(layer.tips("对不起，老师不能提问。",v,{tips:[1,"#5ECFBA"],time:4e3}),c(this)):($.ajax({url:"/common/question_post_lps4/",data:_,dataType:"json",type:"POST",success:function(t){var e=$(".QA_lists");if("success"==t.status){u();var s=$(t.html);s.hide(),e.prepend(s),s.fadeIn(),$("html, body").animate({scrollTop:s.offset().top-i()},1e3),v.val(""),l(),a(),c(p)}}}),$(".upload_btn").removeClass("have_img"))});var k=function(){$(".like").off("click").on("click",function(e){if(!g)return t(),!1;e.stopPropagation();var i=$(this),s=i.parent().attr("data-discuss-id");$.ajax({url:"/home/s/ajax_praise/",method:"POST",dataType:"json",data:{problem_id:s},success:function(e){if(e.success){var s=e.data.action;e.data.praise_count,"mark"==s?i.addClass("selected"):"cancel"==s&&i.removeClass("selected")}else if(401==e.code)return t("登录状态已过期！"),!1}})})};k(),r(),p();var A=function(t,e,s,n,l,r,o){""==n?(layer.tips("请输入回复内容！",$(o).parent().siblings(".input_area"),{tips:[1,"#5ECFBA"],time:3e3}),c(o)):$.ajax({url:"/common/answer_post_lps4/",data:{object_id:t,parent_id:e,problem_id:s,comment:n,answer_user_id:l,answer_nick_name:r},dataType:"json",type:"POST",success:function(t){if("success"==t.status){var e=$(o).parents(".parent_discuss").children(".children_discuss");"none"==e.css("display")&&e.show();var s=$(t.html);s.hide(),e.append(s),s.fadeIn(),$("html, body").animate({scrollTop:s.offset().top-i()},1e3),$(o).parent().siblings(".input_area").children("textarea").val(""),$(o).parent().parent().prev().children(".reply").click(),a(),c(o)}else layer.tips(t.msg,$(o),{tips:[1,"#5ECFBA"],time:3e3})}})},C=$(".QA_more");h();var q=function(e,i,s,n){return g?($.ajax({url:"/common/"+s+"_more_lps4/"+e+"/"+i+"/",dataType:"html",type:"GET",success:function(t){if("failed"==$.parseJSON(t).status)C.text("没有更多").off("click");else{var e=$($.parseJSON(t).html);e.hide(),n.append(e),e.fadeIn()}$(".all-questions, .my-questions, .one-question-view").jScrollPane({mouseWheelSpeed:100}),a()}}),void 0):(t(),!1)};d(),$(".my_join>em").off("click").on("click",function(){if(!g)return t(),!1;$(this).toggleClass("actived");var e=$(this).hasClass("actived"),i=$(".QA_lists"),s=y;e?0==$(i).children().length?_("my"):j(s,"my",i):j(s,"all",i),h()});var j=function(e,i,s){return g?($.ajax({url:"/common/"+i+"_more_lps4/"+e+"/0/",dataType:"html",type:"GET",success:function(t){if("failed"==$.parseJSON(t).status)m(i);else{var e=$($.parseJSON(t).html);""==$.trim($.parseJSON(t).html)?m(i):(u(),e.hide(),s.html(e),e.fadeIn())}$(".all-questions, .my-questions, .one-question-view").jScrollPane({mouseWheelSpeed:100}),a()}}),void 0):(t(),!1)};$(".img_mc1>.ckdt").css({width:function(){var t=new Image;t.src=$(this).siblings("img").attr("src");var e=t.width,i=$(this).parent().parent().parent(".txt_img").css("max-width").split("px")[0];return e>i?i:t.width},height:function(){var t=new Image;t.src=$(this).siblings("img").attr("src");var e=t.height,i=$(this).parent().parent().parent(".txt_img").css("max-height").split("px")[0];return e>i?i:e},"padding-top":function(){var t=new Image;t.src=$(this).siblings("img").attr("src");var e=t.height,i=$(this).parent().parent().parent(".txt_img").css("max-height").split("px")[0];return e>i?(i-24)/2:(e-24)/2}}),v.off("focus").on("focus",function(){return g?($(this).parent(".message_wrap").addClass("actived"),void 0):(t(),!1)}),v.off("blur").on("blur",function(){$(this).parent(".message_wrap").removeClass("actived")}),$(".show_more").off("click").on("click",function(){var t=$(this).text();$(".tea_intro").children("p").height(),"收起↑"==t?($(this).siblings(".tea_intro").animate({"max-height":"72px"},500),setTimeout("$('.show_more').text('展示全部↓')",600)):($(this).siblings(".tea_intro").animate({"max-height":"216px"},500),$(this).text("收起↑"))});var Q=$(".next"),T=$(".prev");Q.off("click").on("click",function(){f(1)}),T.off("click").on("click",function(){var t=$(".video").height()-Q.height()-T.height(),e=parseInt($(this).siblings(".lesson").children("ul").css("margin-top").split("px")[0]),i=$(this).siblings(".lesson").children("ul").children("li").eq(0).position().top;Q.removeAttr("title"),i>=40?$(this).attr("title","这已是第一页"):i>=-t&&40>i?$(this).siblings(".lesson").children("ul").animate({"margin-top":0},500):($(this).removeAttr("title"),e+=t,e+="px",$(this).siblings(".lesson").children("ul").animate({"margin-top":e},500))}),$(".catalog ul li a,.catalog ul li span").hover(function(){var t=$(this).prop("tagName");if("A"==t)var e=$(this).parent("li").position().top-5;else var e=$(this).parent("li").position().top+7;var e=e+"px",i=$(this).attr("name");$(this).parent("li").parent("ul").siblings(".title").css({top:e,display:"table"}).children("span").text(i)},function(){$(this).parent("li").parent("ul").siblings(".title").hide()}),$(".kj a").on("click",function(){g||t()}),$(".lesson li").each(function(t){if($(this).children().hasClass("selected")){var e=Math.ceil(t/13-1);e>0&&f(e)}}),$(".tea_intro").jScrollPane({mouseWheelSpeed:100});var F=window.location.search.match(/p_id=([^&]+)/);if(F){var S=F[1],I=$("#"+S);I.length>0&&(setTimeout(function(){$("html, body").animate({scrollTop:I.offset().top-i()},1e3)},500),I.css({background:"#FCFFC2",transition:"background-color 2s ease-in-out","-moz-transition":"background-color 2s ease-in-out","-webkit-transition":"background-color 2s ease-in-out","-o-transition":"background-color 2s ease-in-out"}),setTimeout(function(){I.css({background:"#FFFFFF"})},2e3))}});